<!-- filename: views/board/view.ejs -->
<div class="card">
  <h2><%= board.title %></h2>
  <div style="color: #6c757d; margin: 12px 0; font-size: 0.9rem;">
    작성자: <%= board.author %> | 조회수: <%= board.views %> | 
    작성일: <%= new Date(board.createdAt).toLocaleDateString('ko-KR') %>
  </div>
  <hr style="margin: 16px 0; border-color: #e9ecef;">
  <div style="white-space: pre-wrap; line-height: 1.8;"><%= board.content %></div>
</div>

<div style="display: flex; gap: 8px; margin-top: 16px;">
  <a href="/boards" class="btn btn-secondary">목록으로</a>
  <a href="/boards/<%= board._id %>/edit" class="btn btn-primary">수정</a>
  <form method="POST" action="/boards/<%= board._id %>?_method=DELETE" style="display: inline;"
    onsubmit="return confirm('정말 삭제하시겠습니까?')">
    <button type="submit" class="btn btn-danger">삭제</button>
  </form>
</div>

<!-- 댓글 섹션 -->
<div class="mt-5">
  <h4>댓글</h4>
  <div id="comment-list" class="mb-4">
    <p class="text-muted">댓글을 불러오는 중...</p>
  </div>
  <% if (currentUser) { %>
  <form action="/comments/<%= board._id %>" method="POST">
    <div class="mb-3">
      <textarea
        name="content"
        class="form-control"
        rows="3"
        placeholder="댓글을 입력하세요."
        required
      ></textarea>
    </div>
    <button type="submit" class="btn btn-primary">댓글 등록</button>
  </form>
  <% } else { %>
  <p class="text-muted">댓글을 작성하려면 <a href="/auth/login">로그인</a>이 필요합니다.</p>
  <% } %>
</div>

<script>
  fetch('/comments/<%= board._id %>/list')
    .then((res) => res.json())
    .then((data) => {
      const list = document.getElementById('comment-list');
      if (!data.comments || data.comments.length === 0) {
        list.innerHTML = '<p class="text-muted">아직 댓글이 없습니다.</p>';
        return;
      }
      list.innerHTML = data.comments
        .map(
          (c) => `
          <div class="border rounded p-3 mb-2">
            <div class="d-flex justify-content-between">
              <strong>${c.author?.name || '알 수 없음'}</strong>
              <small class="text-muted">${new Date(c.createdAt).toLocaleDateString('ko-KR')}</small>
            </div>
            <p class="mb-0 mt-1">${c.content}</p>
          </div>`
        )
        .join('');
    })
    .catch(() => {
      document.getElementById('comment-list').innerHTML =
        '<p class="text-danger">댓글을 불러오지 못했습니다.</p>';
    });
</script>
